<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trening Tracker</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.83/dist/themes/light.css" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.83/dist/shoelace.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f2f2f7;
      color: #000;
      max-width: 390px;
      margin: auto;
    }
    h1 {
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    #upload-section {
      margin-bottom: 1.5rem;
    }
    .exercise {
      background: white;
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .done {
      color: green;
      font-weight: bold;
      font-size: 1.2rem;
    }
    sl-button::part(base) {
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>Trening - Dzień <span id="day-number"></span></h1>
  <div id="upload-section">
    <input type="file" id="csvFile" accept=".csv" />
    <sl-button variant="primary" onclick="resetProgress()">Resetuj Progres</sl-button>
  </div>
  <div id="exercise-list"></div>

  <script type="module">
    import initSqlJs from 'https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js';

    let db, todayData = {}, dbLoaded = false;

    const initDB = async () => {
      const SQL = await initSqlJs({ locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/${file}` });
      const saved = localStorage.getItem('trening_db');
      db = new SQL.Database(saved ? new Uint8Array(JSON.parse(saved)) : undefined);
      if (!saved) db.run("CREATE TABLE progress(day INT, pushups INT, plank INT, bike INT);");
      dbLoaded = true;
    };

    const saveDB = () => {
      const data = db.export();
      localStorage.setItem('trening_db', JSON.stringify(Array.from(data)));
    };

    const resetProgress = () => {
      if (confirm("Czy na pewno chcesz zresetować postęp?")) {
        localStorage.removeItem('trening_db');
        location.reload();
      }
    };

    const readCSV = async file => {
      const text = await file.text();
      const rows = text.trim().split("\n").slice(1);
      return rows.map(r => {
        const [day, pushups, plank, bike] = r.split(',');
        return { day: +day, pushups: +pushups, plank: +plank, bike: +bike };
      });
    };

    const markDone = (day, type) => {
      const row = db.exec(`SELECT * FROM progress WHERE day = ${day}`);
      if (row.length === 0) db.run(`INSERT INTO progress VALUES (${day}, 0, 0, 0);`);
      db.run(`UPDATE progress SET ${type} = 1 WHERE day = ${day}`);
      saveDB();
      showToday(todayData);
    };

    const isDone = (day, type) => {
      const row = db.exec(`SELECT ${type} FROM progress WHERE day = ${day}`);
      return row[0]?.values[0][0] === 1;
    };

    const showToday = (plan) => {
      const day = plan.day;
      document.getElementById("day-number").textContent = day;
      const container = document.getElementById("exercise-list");
      container.innerHTML = '';

      const types = [
        { label: "Pompki", type: "pushups", amount: plan.pushups },
        { label: "Plank", type: "plank", amount: plan.plank },
        { label: "Rower", type: "bike", amount: plan.bike },
      ];

      types.forEach(({ label, type, amount }) => {
        const wrapper = document.createElement("div");
        wrapper.className = "exercise";

        const title = document.createElement("div");
        title.innerHTML = `<strong>${label}:</strong> ${amount} ${type === 'plank' ? 'sekund' : (type === 'bike' ? 'minut' : 'powtórzeń')}`;

        const content = document.createElement("div");
        if (isDone(day, type)) {
          content.innerHTML = `<div class='done'>${label} wykonane</div>`;
        } else if (type === 'plank') {
          const btn = document.createElement("sl-button");
          btn.textContent = "Start";
          btn.variant = "success";
          btn.addEventListener("click", () => {
            btn.disabled = true;
            let remaining = amount;
            btn.textContent = `Pozostało ${remaining}s`;
            const interval = setInterval(() => {
              remaining--;
              if (remaining <= 0) {
                clearInterval(interval);
                markDone(day, type);
              } else {
                btn.textContent = `Pozostało ${remaining}s`;
              }
            }, 1000);
          });
          content.appendChild(btn);
        } else {
          const btn = document.createElement("sl-button");
          btn.textContent = `Rozpocznij ${label}`;
          btn.variant = "primary";
          btn.addEventListener("click", () => markDone(day, type));
          content.appendChild(btn);
        }

        wrapper.appendChild(title);
        wrapper.appendChild(content);
        container.appendChild(wrapper);
      });
    };

    document.getElementById("csvFile").addEventListener("change", async (e) => {
      localStorage.removeItem('trening_db');
      await initDB();
      const file = e.target.files[0];
      const plan = await readCSV(file);
      todayData = plan.find(row => {
        const rowDone = db.exec(`SELECT * FROM progress WHERE day = ${row.day}`);
        return !rowDone[0] || rowDone[0].values[0].includes(0);
      }) || plan[plan.length - 1];
      showToday(todayData);
    });

    await initDB();
  </script>
</body>
</html>
