const token = 'hLd2SmS16HxaZFzKjeghR75u';
const locale = 'pl';
const speciesApiUrl = `https://app.birdweather.com/api/v1/stations/${token}/species?locale=${locale}&limit=10`;
const detectionsApiUrl = `https://app.birdweather.com/api/v1/stations/${token}/detections?locale=${locale}&limit=1`;

// Funkcja do otwierania strony Wikipedii na podstawie nazwy ptaka
function openWikipediaPage(birdName) {
    const wikiUrl = `https://pl.wikipedia.org/wiki/${encodeURIComponent(birdName)}`;
    window.open(wikiUrl, '_blank'); // Otwiera link w nowej karcie
}

async function fetchLastDetection() {
    try {
        const response = await fetch(detectionsApiUrl, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await response.json();

        console.log("Pełna odpowiedź API dla ostatniego wykrycia:", data);

        if (data.success && data.detections && data.detections.length > 0) {
            const lastDetection = data.detections[0];
            
            const birdName = lastDetection.species ? lastDetection.species.commonName : "Nieznany ptak";
            const detectionTime = lastDetection.timestamp ? new Date(lastDetection.timestamp).toLocaleString('pl-PL') : "Data nieznana";
            const birdImageUrl = lastDetection.species && lastDetection.species.imageUrl ? lastDetection.species.imageUrl : "placeholder.jpg";

            document.getElementById("bird-name").querySelector("span").textContent = birdName;
            document.getElementById("bird-detection-time").querySelector("span").textContent = detectionTime;
            const birdImage = document.getElementById("bird-image");
            birdImage.src = birdImageUrl;
            birdImage.alt = birdName;

            // Dodajemy onclick, aby otworzyć stronę Wikipedii
            birdImage.onclick = () => openWikipediaPage(birdName);
        } else {
            console.error("Nie udało się pobrać danych o ostatnim wykryciu lub dane są niekompletne:", data);
        }
    } catch (error) {
        console.error("Błąd podczas wykonywania zapytania:", error);
    }
}

async function fetchTopSpecies() {
    try {
        const response = await fetch(speciesApiUrl, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await response.json();

        console.log("Pełna odpowiedź API dla top gatunków:", data);

        if (data.success && data.species && data.species.length > 0) {
            const speciesTableBody = document.getElementById("species-table-body");
            speciesTableBody.innerHTML = ''; // Czyści istniejące wiersze

            data.species.forEach(bird => {
                const row = document.createElement("tr");

                // Tworzenie komórki z obrazem ptaka
                const birdImageCell = document.createElement("td");
                const birdImage = document.createElement("img");
                birdImage.src = bird.imageUrl; // URL do zdjęcia ptaka
                birdImage.alt = bird.commonName; // Nazwa ptaka

                // Dodajemy onclick, aby otworzyć stronę Wikipedii
                birdImage.onclick = () => openWikipediaPage(bird.commonName);

                birdImageCell.appendChild(birdImage);
                row.appendChild(birdImageCell);

                const detectionsCell = document.createElement("td");
                detectionsCell.textContent = bird.detections ? bird.detections.total : "0";
                row.appendChild(detectionsCell);

                const lastDetectionCell = document.createElement("td");
                lastDetectionCell.textContent = bird.latestDetectionAt ? new Date(bird.latestDetectionAt).toLocaleString('pl-PL') : "Data nieznana";
                row.appendChild(lastDetectionCell);

                speciesTableBody.appendChild(row);
            });
        } else {
            console.error("Brak danych o gatunkach:", data);
        }
    } catch (error) {
        console.error("Błąd podczas wykonywania zapytania:", error);
    }
}

// Wywołanie funkcji na starcie
fetchLastDetection();
fetchTopSpecies();
